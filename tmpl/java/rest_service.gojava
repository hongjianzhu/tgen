package {{ .BaseJava.Namespace }};

/**
 * This file is auto-generated by tgen
 * Don't change manually
 */
import com.android.volley.Request;
import com.android.volley.Response;
import com.android.volley.Response.Listener;
import com.android.volley.VolleyError;
import com.daigou.sg.rpc.BaseModule;
import com.daigou.sg.rpc.GsonUtils;
import com.daigou.sg.rpc.RpcRequest;
import com.daigou.sg.rpc.TRpc;
import com.google.gson.Gson;

import java.nio.charset.Charset;
import java.util.ArrayList;
import java.util.HashMap;

{{ $js := . -}}
public class {{ .Service.Name}}Service {
    private static final Gson gson = GsonUtils.getGsonInstance();
    private static int msgID = 1;

    private {{ .Service.Name}}Service() {
        // Constructor hidden because this is a singleton
    }

    private static String getMsgID() {
        msgID += 1;
        return Integer.toString(msgID);
    }
{{ range $k, $method := $.Service.Methods }}
    public static RpcRequest {{ $method.Name }}({{ $method | $js.BaseJava.AssembleParams }}) {
        RpcRequest req = new RpcRequest(Request.Method.POST, TRpc.getWebApiUrl() + "{{ $js.Service.Name }}/{{ $method.Name }}",
            new Response.Listener<String>() {
                @Override
                public void onResponse(String response) {
                    {{- if $method.ReturnType }}
                    try {
                        {{ $method.ReturnType | $js.BaseJava.ObjectTypecast }} result;

                        {{- if eq $method.ReturnType.Name "string" }}
                        result = BaseModule.doFromJSON(response, String.class);
                        {{- else if eq $method.ReturnType.Name "bool" }}
                        result = BaseModule.doFromJSON(response, Boolean.class);
                        {{- else if eq $method.ReturnType.Name "i16" }}
                        result = BaseModule.doFromJSON(response, Short.class);
                        {{- else if eq $method.ReturnType.Name "i32" }}
                        result = BaseModule.doFromJSON(response, Integer.class);
                        {{- else if eq $method.ReturnType.Name "i64" }}
                        result = BaseModule.doFromJSON(response, Long.class);
                        {{- else if eq $method.ReturnType.Name "double" }}
                        result = BaseModule.doFromJSON(response, Double.class);
                        {{- else if or (eq $method.ReturnType.Name "set") (eq $method.ReturnType.Name "list") }}
                        result = BaseModule.doFromJSONArray(response, {{ $method.ReturnType | $js.BaseJava.GetInnerType }}.class);
                        {{- else if eq $method.ReturnType.Name "map" }}
                        <!-- map is ignored -->
                        {{- else }}
                        result = BaseModule.doFromJSON(response, {{ $method.ReturnType | $js.BaseJava.GetInnerType }}.class);
                        {{- end }}

                        listener.onResponse(result);
                    } catch (Exception ex) {

                        // Log.d("ex", ex.toString());
                        // Log.d("jsonObject", response);

                        listener.onResponse(null);
                    }
                    {{- else -}}
                    if (listener != null) {
                        listener.onResponse(null);
                    }
                    {{- end }}
                }
            }, new Response.ErrorListener() {
            @Override
            public void onErrorResponse(VolleyError error) {
                listener.onResponse(null);
            }
        }) {
            @Override
            public byte[] getBody() {
                {{- if $method.Arguments }}
                java.util.HashMap<String, Object> msg = new java.util.HashMap<String, Object>();
                {{- range $arg := $method.Arguments }}
                {{$fieldname := $js.FilterVariableName $arg.Name}}
                {{- if $js.BaseJava.IsEnum $arg.Type}}
                int {{$fieldname}}Value = ((com.daigou.sg.rpc.DeserializerEnum) {{$fieldname}}).getValue();
                msg.put("{{ $fieldname }}", {{ $fieldname }}Value);
                {{- else}}
                msg.put("{{ $fieldname }}", {{ $fieldname }});
                {{- end}}
                {{- end }}

                return gson.toJson(msg).getBytes(Charset.forName("UTF-8"));
                {{- else }}
                return "".getBytes(Charset.forName("UTF-8"));
                {{- end }}
            }
        };
        TRpc.getQueue().add(req);
        return req;
    }
{{ end -}}
}
